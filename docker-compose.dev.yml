version: '3.8'

services:
  # Minimal dev shell for devcontainer - just for code editing
  app:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: dev-shell
      args:
        - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-charlespick/Aether-V}
    image: aetherv:dev-shell
    container_name: aetherv-dev
    volumes:
      # Mount entire workspace for code editing
      - .:/workspace:cached
      # Mount .env file
      - ./server/.env:/workspace/server/.env:rw
      # Persist pip packages across rebuilds
      - pip-cache:/root/.cache/pip
      - pip-installed:/usr/local/lib/python3.11/site-packages
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/workspace/server
      - DEV_MODE=1
    entrypoint: ["/bin/bash", "-c"]
    command: 
      - |
        # Install Python packages on first run for IntelliSense
        if [ ! -f /root/.pip-installed ]; then
          echo "ðŸ“¦ Installing Python packages for IntelliSense (one-time setup)..."
          pip install --no-cache-dir -r /tmp/requirements.txt
          pip install --no-cache-dir pytest pytest-asyncio pytest-cov httpx black flake8
          touch /root/.pip-installed
          echo "âœ… Packages installed!"
        fi
        # Keep container running for devcontainer
        sleep infinity
    networks:
      - aetherv-dev
  
  # Full application server - only used when running via `make dev-up`
  app-server:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: development
      args:
        - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-charlespick/Aether-V}
    image: aetherv:dev
    container_name: aetherv-server
    ports:
      - "8000:8000"
    volumes:
      # Mount application code for live reload
      - ./server/app:/app/app:cached
      - ./server/tests:/app/tests:cached
      - ./Schemas:/app/Schemas:ro
      - ./Assets:/app/Assets:ro
      # Mount workspace root for utilities
      - .:/workspace:cached
      # Mount .env file
      - ./server/.env:/app/.env:ro
      # Cache pip packages for faster rebuilds
      - pip-cache:/root/.cache/pip
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app
      - DEV_MODE=1
    command: python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - aetherv-dev

  # Build tools service for ISO and asset generation
  build-tools:
    image: ghcr.io/charlespick/aetherv-build-tools:latest
    container_name: aetherv-build-tools
    volumes:
      - .:/workspace:cached
    working_dir: /workspace
    entrypoint: ["/bin/bash"]
    command: ["-c", "echo 'Build tools container ready. Use: docker compose exec build-tools <command>'"]
    networks:
      - aetherv-dev
    profiles:
      - tools

volumes:
  pip-cache:
    driver: local
  pip-installed:
    driver: local

networks:
  aetherv-dev:
    driver: bridge
